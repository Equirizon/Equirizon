import { defineMiddleware } from 'astro:middleware'

export const onRequest = defineMiddleware(async (context, next) => {
  const { pathname } = context.url;

  // 1. Short-circuit for everything non-admin
  if (!pathname.startsWith('/admin')) {
    return next();
  }

  const isAdmin = context.cookies.has('admin');

  // 2. Simplified logic: If not logged in and not on the auth page, go to auth
  if (!isAdmin && pathname === '/admin') {
    return context.redirect('/admin/auth');
  }

  // 3. If already logged in and trying to go to auth, go back to dashboard
  if (isAdmin && pathname.startsWith('/admin/auth')) {
    return context.redirect('/admin');
  }

  return next();
});